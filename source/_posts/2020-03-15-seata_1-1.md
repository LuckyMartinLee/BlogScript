---

title: seata 与 分布式事务
date: 2020-01-13 14:16:21
tags:
- Java
typora-root-url: ..
---



#### CAP 理论

##### C - Consistency

一致性是指写操作后的读操作可以读取到最新的数据状态，当数据分布在多个节点上，从任意结点读取到的数据都是最新的状态。

如何实现一致性？

1. 写入主数据库后要将数据同步到从数据库。
2. 写入主数据库后，在向从数据库同步期间要将从数据库锁定，待同步完成后再释放锁，以免在新数据写入成功后，向从数据库查询到旧的数据。

分布式系统一致性的特点：

1. 由于存在数据同步的过程，写操作的响应会有一定的延迟。
2. 为了保证数据一致性会对资源暂时锁定，待数据同步完成释放锁定资源。
3. 如果请求数据同步失败的结点则会返回错误信息，一定不会返回旧数据。

##### A - Availability

可用性是指任何事务操作都可以得到响应结果，且不会出现响应超时或响应错误。

如何实现可用性

1. 写入主数据库后要将数据同步到从数据库。

1. 由于要保证从数据库的可用性，不可将从数据库中的资源进行锁定。
2. 即时数据还没有同步过来，从数据库也要返回要查询的数据，哪怕是旧数据，如果连旧数据也没有则可以按照约定返回一个默认信息，但不能返回错误或响应超时。

分布式系统可用性的特点：**所有请求都有响应，且不会出现响应超时或响应错误**

##### P - Partition tolerance

通常分布式系统的各各结点部署在不同的子网，这就是网络分区，不可避免的会出现由于网络问题而导致结点之间通信失败，此时仍可对外提供服务，这叫分区容忍性。

如何实现分区容忍性？

1. 尽量使用异步取代同步操作，例如使用异步方式将数据从主数据库同步到从数据，这样结点之间能有效的实现松耦合。

1. 添加从数据库结点，其中一个从结点挂掉其它从结点提供服务。

分布式分区容忍性的特点：**分区容忍性分是布式系统具备的基本能力**



#### 分布式事务实现方式

- 分阶段提交

  分阶段提交是一种强一致性设计，它引入一个事务协调者的角色来协调管理各参与者（也可称之为各本地资源）的提交和回滚，简单来说阶段分别指的是准备（投票）和提交两个阶段。

  具体流程：

  1、准备阶段协调者会给各参与者发送准备命令，可以把准备命令理解成除了提交事务之外所有事都做完了。

  2、同步等待所有资源的响应之后就进入第二阶段即提交阶段（注意提交阶段不一定是提交事务，也可能是回滚事务）。

  假如在第一阶段所有参与者都返回准备成功，那么协调者则向所有参与者发送提交事务命令，然后等待所有事务都提交成功之后，返回事务执行成功。

  假如在第一阶段有一个参与者返回失败，那么协调者就会向所有参与者发送回滚事务的请求，即分布式事务执行失败。

- TCC

  Try 指的是预留，即资源的预留和锁定，**注意是预留**。

  Confirm 指的是确认操作，这一步其实就是真正的执行了。

  Cancel 指的是撤销操作，可以理解为把预留阶段的动作撤销了。

- AT

